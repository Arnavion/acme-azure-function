{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"app_insights_name": {
			"type": "string"
		},
		"cdn_profile_name": {
			"type": "string"
		},
		"cdn_endpoint_name": {
			"type": "string"
		},
		"cdn_custom_domain_name": {
			"type": "string"
		},
		"domain_name": {
			"type": "string"
		},
		"function_app_name": {
			"type": "string"
		},
		"keyvault_name": {
			"type": "string"
		},
		"storage_account_name": {
			"type": "string"
		},

		"server_farms_linux_consumption_plan_name": {
			"defaultValue": "WestUSLinuxDynamicPlan",
			"type": "string"
		}
	},
	"variables": {},
	"resources": [{
		"type": "Microsoft.Cdn/profiles",
		"apiVersion": "2016-04-02",
		"name": "[parameters('cdn_profile_name')]",
		"location": "[resourceGroup().location]",
		"sku": {
			"name": "Standard_Microsoft"
		}
	}, {
		"type": "Microsoft.Cdn/profiles/endpoints",
		"apiVersion": "2016-04-02",
		"name": "[concat(parameters('cdn_profile_name'), '/', parameters('cdn_endpoint_name'))]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Cdn/profiles', parameters('cdn_profile_name'))]",
			"[resourceId('Microsoft.Storage/storageAccounts', parameters('storage_account_name'))]"
		],
		"properties": {
			"contentTypesToCompress": [
				"application/eot",
				"application/font",
				"application/font-sfnt",
				"application/javascript",
				"application/json",
				"application/opentype",
				"application/otf",
				"application/truetype",
				"application/ttf",
				"application/vnd.ms-fontobject",
				"application/xhtml+xml",
				"application/xml",
				"application/xml+rss",
				"application/x-font-opentype",
				"application/x-font-truetype",
				"application/x-font-ttf",
				"application/x-opentype",
				"application/x-otf",
				"application/x-ttf",
				"font/eot",
				"font/ttf",
				"font/otf",
				"font/opentype",
				"image/svg+xml",
				"text/css",
				"text/html",
				"text/javascript",
				"text/plain",
				"text/xml"
			],
			"originHostHeader": "[replace(replace(reference(concat('Microsoft.Storage/storageAccounts/', parameters('storage_account_name')), '2019-04-01', 'Full').properties.primaryEndpoints.web, 'https:', ''), '/', '')]",
			"origins": [{
				"name": "[concat(parameters('storage_account_name'), '-blob-core-windows-net')]",
				"properties": {
					"hostName": "[replace(replace(reference(concat('Microsoft.Storage/storageAccounts/', parameters('storage_account_name')), '2019-04-01', 'Full').properties.primaryEndpoints.web, 'https:', ''), '/', '')]"
				}
			}],
			"isCompressionEnabled": true,
			"isHttpAllowed": true,
			"isHttpsAllowed": true,
			"queryStringCachingBehavior": "IgnoreQueryString"
		}
	}, {
		"type": "Microsoft.Cdn/profiles/endpoints/providers/roleAssignments",
		"apiVersion": "2018-01-01-preview",
		"name": "[concat(parameters('cdn_profile_name'), '/', parameters('cdn_endpoint_name'), '/Microsoft.Authorization/', guid(parameters('cdn_profile_name'), parameters('cdn_endpoint_name'), parameters('function_app_name')))]",
		"dependsOn": [
			"[resourceId('Microsoft.Cdn/profiles/endpoints', parameters('cdn_profile_name'), parameters('cdn_endpoint_name'))]",
			"[resourceId('Microsoft.Web/sites', parameters('function_app_name'))]"
		],
		"properties": {
			"roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '426e0c7f-0c7e-4658-b36f-ff54d6c29b45')]",
			"principalId": "[reference(concat('Microsoft.Web/sites/', parameters('function_app_name')), '2016-08-01', 'Full').identity.principalId]"
		}
	}, {
		"type": "Microsoft.Cdn/profiles/endpoints/customdomains",
		"apiVersion": "2016-04-02",
		"name": "[concat(parameters('cdn_profile_name'), '/', parameters('cdn_endpoint_name'), '/', parameters('cdn_custom_domain_name'))]",
		"dependsOn": [
			"[resourceId('Microsoft.Cdn/profiles/endpoints', parameters('cdn_profile_name'), parameters('cdn_endpoint_name'))]"
		],
		"properties": {
			"hostName": "[parameters('domain_name')]"
		}
	}, {
		"type": "Microsoft.Insights/components",
		"apiVersion": "2015-05-01",
		"name": "[parameters('app_insights_name')]",
		"location": "[resourceGroup().location]",
		"kind": "web",
		"properties": {
			"Application_Type": "web"
		}
	}, {
		"type": "Microsoft.KeyVault/vaults/accessPolicies",
		"apiVersion": "2016-10-01",
		"name": "[concat(parameters('keyvault_name'), '/add')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Web/sites', parameters('function_app_name'))]"
		],
		"properties": {
			"accessPolicies": [{
				"objectId": "684d1a83-7c8b-4632-9b6a-81da9ca6fb01",
				"permissions": {
					"secrets": [
						"get"
					]
				},
				"tenantId": "[subscription().tenantId]"
			}, {
				"objectId": "[reference(concat('Microsoft.Web/sites/', parameters('function_app_name')), '2016-08-01', 'Full').identity.principalId]",
				"permissions": {
					"certificates": [
						"get"
					]
				},
				"tenantId": "[subscription().tenantId]"
			}]
		}
	}, {
		"type": "Microsoft.Web/serverfarms",
		"apiVersion": "2016-09-01",
		"name": "[parameters('server_farms_linux_consumption_plan_name')]",
		"location": "[resourceGroup().location]",
		"sku": {
			"name": "Y1",
			"tier": "Dynamic",
			"size": "Y1",
			"family": "Y",
			"capacity": 0
		},
		"kind": "functionapp",
		"properties": {
			"name": "[parameters('server_farms_linux_consumption_plan_name')]",
			"reserved": true
		}
	}, {
		"type": "Microsoft.Storage/storageAccounts",
		"apiVersion": "2019-04-01",
		"name": "[parameters('storage_account_name')]",
		"location": "[resourceGroup().location]",
		"kind": "StorageV2",
		"sku": {
			"name": "Standard_LRS",
			"tier": "Standard"
		},
		"properties": {
			"encryption": {
				"keySource": "Microsoft.Storage",
				"services": {
					"blob": {
						"enabled": true
					}
				}
			},
			"supportsHttpsTrafficOnly": true
		}
	}, {
		"type": "Microsoft.Web/sites",
		"apiVersion": "2016-08-01",
		"name": "[parameters('function_app_name')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Web/serverfarms', parameters('server_farms_linux_consumption_plan_name'))]"
		],
		"kind": "functionapp,linux",
		"identity": {
			"type": "SystemAssigned"
		},
		"properties": {
			"enabled": true,
			"hostNameSslStates": [{
				"name": "[concat(parameters('function_app_name'), '.azurewebsites.net')]",
				"sslState": "Disabled",
				"hostType": "Standard"
			}, {
				"name": "[concat(parameters('function_app_name'), '.scm.azurewebsites.net')]",
				"sslState": "Disabled",
				"hostType": "Repository"
			}],
			"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('server_farms_linux_consumption_plan_name'))]",
			"reserved": true,
			"httpsOnly": true
		}
	}, {
		"type": "Microsoft.Web/sites/config",
		"apiVersion": "2016-08-01",
		"name": "[concat(parameters('function_app_name'), '/web')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Web/sites', parameters('function_app_name'))]"
		],
		"properties": {
			"netFrameworkVersion": "v4.0",
			"publishingUsername": "[concat('$', parameters('function_app_name'))]",
			"scmType": "None",
			"alwaysOn": false,
			"ftpsState": "Disabled"
		}
	}, {
		"type": "Microsoft.Web/sites/hostNameBindings",
		"apiVersion": "2016-08-01",
		"name": "[concat(parameters('function_app_name'), '/', parameters('function_app_name'), '.azurewebsites.net')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Web/sites', parameters('function_app_name'))]"
		],
		"properties": {
			"siteName": "[parameters('function_app_name')]",
			"hostNameType": "Verified"
		}

	}]
}
