{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"app_insights_name": {
			"type": "string"
		},
		"function_app_name": {
			"type": "string"
		},
		"keyvault_name": {
			"type": "string"
		},
		"storage_account_name": {
			"type": "string"
		},
		"top_level_domain_name": {
			"type": "string"
		},

		"server_farms_linux_consumption_plan_name": {
			"defaultValue": "WestUSLinuxDynamicPlan",
			"type": "string"
		}
	},
	"variables": {},
	"resources": [{
		"type": "Microsoft.Insights/components",
		"apiVersion": "2015-05-01",
		"name": "[parameters('app_insights_name')]",
		"location": "[resourceGroup().location]",
		"kind": "web",
		"properties": {
			"Application_Type": "web"
		}
	}, {
		"type": "Microsoft.KeyVault/vaults/accessPolicies",
		"apiVersion": "2016-10-01",
		"name": "[concat(parameters('keyvault_name'), '/add')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Web/sites', parameters('function_app_name'))]"
		],
		"properties": {
			"accessPolicies": [{
				"objectId": "[reference(concat('Microsoft.Web/sites/', parameters('function_app_name')), '2016-08-01', 'Full').identity.principalId]",
				"permissions": {
					"secrets": [
						"get",
						"set"
					],
					"certificates": [
						"get",
						"import"
					]
				},
				"tenantId": "[subscription().tenantId]"
			}]
		}
	}, {
		"type": "Microsoft.Network/dnsZones",
		"apiVersion": "2016-04-01",
		"name": "[parameters('top_level_domain_name')]",
		"location": "global"
	}, {
		"type": "Microsoft.Network/dnsZones/providers/roleAssignments",
		"apiVersion": "2018-01-01-preview",
		"name": "[concat(parameters('top_level_domain_name'), '/Microsoft.Authorization/', guid(parameters('top_level_domain_name'), parameters('function_app_name')))]",
		"dependsOn": [
			"[resourceId('Microsoft.Network/dnsZones', parameters('top_level_domain_name'))]",
			"[resourceId('Microsoft.Web/sites', parameters('function_app_name'))]"
		],
		"properties": {
			"roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'befefa01-2a29-4197-83a8-272ff33ce314')]",
			"principalId": "[reference(concat('Microsoft.Web/sites/', parameters('function_app_name')), '2016-08-01', 'Full').identity.principalId]"
		}
	}, {
		"type": "Microsoft.Storage/storageAccounts",
		"apiVersion": "2019-04-01",
		"name": "[parameters('storage_account_name')]",
		"location": "[resourceGroup().location]",
		"kind": "StorageV2",
		"sku": {
			"name": "Standard_LRS",
			"tier": "Standard"
		},
		"properties": {
			"encryption": {
				"keySource": "Microsoft.Storage",
				"services": {
					"blob": {
						"enabled": true
					}
				}
			},
			"supportsHttpsTrafficOnly": true
		}
	}, {
		"type": "Microsoft.Web/serverfarms",
		"apiVersion": "2016-09-01",
		"name": "[parameters('server_farms_linux_consumption_plan_name')]",
		"location": "[resourceGroup().location]",
		"sku": {
			"name": "Y1",
			"tier": "Dynamic",
			"size": "Y1",
			"family": "Y",
			"capacity": 0
		},
		"kind": "functionapp",
		"properties": {
			"name": "[parameters('server_farms_linux_consumption_plan_name')]",
			"reserved": true
		}
	}, {
		"type": "Microsoft.Web/sites",
		"apiVersion": "2016-08-01",
		"name": "[parameters('function_app_name')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Web/serverfarms', parameters('server_farms_linux_consumption_plan_name'))]"
		],
		"kind": "functionapp,linux",
		"identity": {
			"type": "SystemAssigned"
		},
		"properties": {
			"enabled": true,
			"hostNameSslStates": [{
				"name": "[concat(parameters('function_app_name'), '.azurewebsites.net')]",
				"sslState": "Disabled",
				"hostType": "Standard"
			}, {
				"name": "[concat(parameters('function_app_name'), '.scm.azurewebsites.net')]",
				"sslState": "Disabled",
				"hostType": "Repository"
			}],
			"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('server_farms_linux_consumption_plan_name'))]",
			"reserved": true,
			"httpsOnly": true
		}
	}, {
		"type": "Microsoft.Web/sites/config",
		"apiVersion": "2016-08-01",
		"name": "[concat(parameters('function_app_name'), '/web')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Web/sites', parameters('function_app_name'))]"
		],
		"properties": {
			"netFrameworkVersion": "v4.0",
			"publishingUsername": "[concat('$', parameters('function_app_name'))]",
			"scmType": "None",
			"alwaysOn": false,
			"ftpsState": "Disabled"
		}
	}, {
		"type": "Microsoft.Web/sites/hostNameBindings",
		"apiVersion": "2016-08-01",
		"name": "[concat(parameters('function_app_name'), '/', parameters('function_app_name'), '.azurewebsites.net')]",
		"location": "[resourceGroup().location]",
		"dependsOn": [
			"[resourceId('Microsoft.Web/sites', parameters('function_app_name'))]"
		],
		"properties": {
			"siteName": "[parameters('function_app_name')]",
			"hostNameType": "Verified"
		}
	}]
}
